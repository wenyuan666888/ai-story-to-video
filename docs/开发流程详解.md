# 故事转视频平台 — 开发流程详解

本文档说明如何**从零**实现「故事 → 分镜 → 图片 → 视频」的完整开发流程，便于理解每一步在做什么、为什么这样做。

---

## 一、整体流程概览

```
需求分析 → 技术选型 → 数据设计 → 后端 API → 前端页面 → 联调与测试
```

开发时建议**严格按顺序**：先保证「能存数据、能取数据」，再做「AI 生成」，最后做「界面与交互」。

---

## 二、阶段一：需求与设计

### 2.1 需求一句话

> 用户输入一段故事，系统按步骤：① 把故事拆成多个分镜描述 → ② 为每个分镜生成图片 → ③ 为每个分镜生成视频；每一步都可编辑/确认/重新生成，最后可下载视频。

### 2.2 核心名词

| 名词     | 含义 |
|----------|------|
| **项目** | 一条「故事」对应一个项目，包含标题、故事正文、风格、当前进行到哪一阶段 |
| **分镜** | 故事被拆成多段，每段是一个分镜，有顺序、描述文案 |
| **阶段** | draft（草稿）→ scenes（分镜已生成）→ images（图片已生成）→ videos（视频已生成）→ completed（全部完成） |

### 2.3 技术选型（本项目的选择）

- **前端**：Next.js（App Router）+ React + Tailwind CSS  
- **后端**：Next.js API Routes（同一项目里，前后端一体）  
- **数据库 + 认证 + 文件存储**：Supabase（PostgreSQL + Auth + Storage）  
- **故事 → 分镜**：任意「文本生成」模型（本文用 OpenAI 兼容接口，你可换成 GLM/其他）  
- **图片/视频生成**：可先 Mock，再接真实 API（如火山引擎等）  

### 2.4 数据模型（先想清楚再写表结构）

- **projects**：id, user_id, title, story, style, stage, created_at, updated_at  
- **scenes**：id, project_id, order_index, description, 以及各步骤的「是否已确认」、生成状态  
- **images / videos**：id, scene_id, 存储路径、URL、版本号等  

先在一张纸上画出：项目 1–N 分镜，分镜 1–N 图片、1–N 视频，再写 SQL。

---

## 三、阶段二：初始化项目与依赖

### 3.1 创建 Next.js 项目

```bash
npx create-next-app@latest story-to-video-app --typescript --tailwind --eslint --app --src-dir
cd story-to-video-app
```

### 3.2 安装并锁定依赖

- Supabase 客户端：`@supabase/supabase-js`、`@supabase/ssr`  
- 工具：`clsx`、`tailwind-merge`（用于 className 合并）  

```bash
npm install @supabase/supabase-js @supabase/ssr clsx tailwind-merge
```

### 3.3 环境变量

在项目根目录创建 `.env.local`（不要提交到 Git），并复制一份 `.env.local.example` 作为模板提交：

- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`  
- 若用 OpenAI：`OPENAI_API_KEY`（或你用的模型 API Key）  

**开发流程要点**：先让「读配置 → 创建 Supabase 客户端」跑通，再写业务。

---

## 四、阶段三：数据库与 Supabase

### 4.1 设计表结构的顺序

1. 先写 **projects**（和用户挂钩）  
2. 再写 **scenes**（挂在 project 下）  
3. 再写 **images / videos**（挂在 scene 下）  
4. 最后加索引、外键、RLS（行级安全）  

### 4.2 迁移文件

- 在项目里建 `supabase/migrations/`  
- 每个迁移一个文件，如 `001_initial_schema.sql`  
- 在 Supabase 控制台 → SQL Editor 里**按顺序执行**这些 SQL  

### 4.3 客户端封装（开发流程中的关键一步）

- **服务端**（在 API、Server Component 里用）：用 cookie 拿到当前用户，创建「服务端 Supabase 客户端」  
- **浏览器端**（在 React 组件里用）：用 `createBrowserClient`，只负责前端发请求  
- **中间件**：刷新 session、保护需要登录的路由（如 `/projects`、`/create`）  

**流程要点**：先写「谁能访问哪些表」（RLS），再写「怎么在代码里拿到当前用户」，避免后面权限乱掉。

---

## 五、阶段四：认证（登录 / 注册 / 登出）

### 5.1 页面

- `/login`：邮箱 + 密码登录  
- `/register`：注册  
- 登出：一个按钮，调 `supabase.auth.signOut()`，然后跳转到登录页  

### 5.2 开发顺序

1. 先做 **注册**：表单 → 调 Supabase Auth → 成功后跳转登录页  
2. 再做 **登录**：表单 → 调 Supabase Auth → 成功后跳转首页或原目标页  
3. 最后做 **中间件**：未登录访问 `/projects`、`/create` 时重定向到 `/login`；已登录访问 `/login`、`/register` 时重定向首页  

**流程要点**：认证通过后，后续所有 API 都用「当前用户」查 projects/scenes，不再重复写登录逻辑。

---

## 六、阶段五：项目与分镜的「数据层 + API」

### 6.1 数据层（推荐单独文件夹）

例如 `src/lib/db/`：

- **projects.ts**：  
  - `createProject(userId, { title, story, style })`  
  - `getProjects(userId, 分页)`  
  - `getProjectById(projectId)`（可顺带查 scenes）  
  - `updateProject`、`updateProjectStage`、`deleteProject`  
- **scenes.ts**：  
  - `createScenes(projectId, [{ order_index, description }])`  
  - `getScenesByProjectId(projectId)`  
  - `updateSceneDescription`、`confirmSceneDescription` 等  

所有函数内部：用**服务端 Supabase 客户端**，且先校验「当前用户是否拥有该 project」。

### 6.2 API 路由（Next.js App Router）

- `POST /api/projects`：创建项目，调 `createProject`  
- `GET /api/projects`：列表，调 `getProjects`  
- `GET /api/projects/[id]`：详情（含分镜），调 `getProjectById`  
- `PATCH /api/projects/[id]`：更新标题/故事/风格  
- `DELETE /api/projects/[id]`：删除项目  

**流程要点**：先不接 AI，用 Postman/curl 或简单前端表单测通「创建项目 → 查列表 → 查详情」，再进入「故事 → 分镜」。

### 6.3 故事 → 分镜（AI 步骤）

- 新建 `src/lib/ai/story-to-scenes.ts`（或类似）：  
  - 输入：`story`、`style`  
  - 调用你选的模型（OpenAI 兼容接口即可），prompt 要求返回「分镜数组」  
  - 输出：`[{ order_index: 1, description: "..." }, ...]`  
- API：`POST /api/generate/scenes`  
  - 从 body 或根据 projectId 取到 project 的 story/style  
  - 调 AI 得到分镜数组  
  - 删除该 project 下旧 scenes（若有）  
  - 调 `createScenes(projectId, 分镜数组)`  
  - 把 project 的 stage 更新为 `scenes`  

**流程要点**：AI 只负责「文本 → 结构化 JSON」；落库、权限、阶段更新都在 API 里写清楚，便于以后换模型。

---

## 七、阶段六：图片与视频（生成 + 确认）

### 7.1 图片

- **数据层**：  
  - 存图片记录：scene_id、storage_path、url、version  
  - 上传文件到 Supabase Storage，再写一条 image 记录  
- **API**：  
  - `POST /api/generate/image/[sceneId]`：为单个分镜生成图片（可先 Mock：返回占位图或固定图）  
  - 若用真实服务：调第三方 API → 拿到图片 URL/二进制 → 上传到 Storage → 写 DB，并更新 scene 的 image_status  
- **确认**：  
  - `POST /api/scenes/[id]/confirm-image`：把该 scene 的 image_confirmed 设为 true  
  - `POST /api/scenes/confirm-all-images`：全部确认后，把 project.stage 改为 `videos`  

### 7.2 视频

- 同理：video 表、Storage、`POST /api/generate/video/[sceneId]`（可先 Mock 一个静态视频或「生成中」状态）  
- 确认全部视频后：`project.stage = 'completed'`  

**流程要点**：先 Mock 图片/视频，把「生成 → 存库 → 确认 → 阶段推进」跑通，再替换成真实图片/视频 API。

---

## 八、阶段七：前端页面与联调

### 8.1 页面顺序建议

1. **首页**：未登录显示登录/注册入口；已登录显示「创建项目」「我的项目」  
2. **创建项目页**：表单（标题、故事、风格）→ 提交调 `POST /api/projects` → 跳转到项目详情页  
3. **项目列表页**：`GET /api/projects` 或服务端直接查，展示卡片，点击进详情  
4. **项目详情页（核心）**：  
   - 用 `stage` 控制显示哪一块：  
     - draft：显示「生成分镜」按钮 → 调 `POST /api/generate/scenes`  
     - scenes：展示分镜列表，可编辑、确认单条、确认全部 → 再显示「生成图片」  
     - images：展示图片列表，可重新生成、确认 → 再显示「生成视频」  
     - videos：同上，确认全部后进入 completed  
     - completed：展示所有视频、下载  

### 8.2 联调要点

- 每做一个 API，就用接口工具或简单按钮调一遍，再接到页面上  
- 错误处理：API 返回统一格式（如 `{ ok, error?, data? }`），前端根据 `ok` 和 `error` 提示用户  
- 加载状态：生成分镜/图片/视频时加 loading，避免用户重复点击  

---

## 九、开发流程小结（可打印成清单）

| 步骤 | 做什么 | 验收标准 |
|------|--------|----------|
| 1 | 需求与表结构设计 | 能画出 projects → scenes → images/videos 关系图 |
| 2 | 初始化 Next.js + 依赖 + 环境变量 | `npm run dev` 能跑，Supabase 客户端能创建 |
| 3 | 执行 SQL 迁移，封装服务端/浏览器端 Supabase | 能在 API 里用服务端客户端查表 |
| 4 | 登录 / 注册 / 中间件保护路由 | 未登录访问 /projects 会跳登录 |
| 5 | 项目 CRUD 数据层 + API | 能创建项目、查列表、查详情（不含 AI） |
| 6 | 分镜数据层 + 故事→分镜 AI + API | 点击「生成分镜」能拿到分镜并落库 |
| 7 | 图片/视频存储与生成 API（可 Mock） | 能「生成」并看到占位图/视频，能确认 |
| 8 | 前端各页面按 stage 展示与操作 | 能从头到尾走通：创建→分镜→图片→视频→完成 |

按这张表从 1 做到 8，就是一次完整的「从零到可用的开发流程」。  

---

## 十、本仓库中的从零示例项目

目录 **`story-to-video-app/`** 是一份按上述流程从零实现的示例：

- **故事→分镜**：使用 OpenAI 兼容接口（`OPENAI_API_KEY` + `OPENAI_BASE_URL`）；未配置时自动使用内置 Mock 返回示例分镜。
- **图片/视频**：当前为 Mock（占位图 + 示例视频 URL），便于在不接真实 API 的情况下跑通「生成 → 确认 → 阶段推进」的完整流程。

建议阅读顺序：**先看 `docs/开发流程详解.md`（本文档）→ 再按「数据层 → API → 前端」顺序浏览 `story-to-video-app/src` 代码**，即可理解每一步在做什么。
